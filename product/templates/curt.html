{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Cart - FarmFresh</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<!-- Hero Section -->
<div class="container-fluid bg-primary py-5 bg-hero mb-5">
    <div class="container py-5">
        <div class="row justify-content-start">
            <div class="col-lg-8 text-center text-lg-start">
                <h1 class="display-1 text-white mb-md-4">Your Cart</h1>
                <a href="{% url 'home' %}" class="btn btn-primary py-md-3 px-md-5 me-3">Home</a>
                <a href="{% url 'curt' %}" class="btn btn-secondary py-md-3 px-md-5">Cart</a>
            </div>
        </div>
    </div>
</div>

<!-- Cart Table Section -->
<div class="container py-5">
    <div class="table-responsive">
        <table class="table text-center align-middle">
            <thead class="bg-primary text-white">
                <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th style="width: 120px;">Quantity</th>
                    <th>Subtotal</th>
                    <th>Remove</th>
                </tr>
            </thead>
            <tbody>
                <!-- Cart items will be dynamically inserted here -->
            </tbody>
        </table>

        <div class="text-end">
            <h4>Total: <span id="total-price">$0.00</span></h4>
            <a href="{% url 'checkout' %}" class="btn btn-success">Proceed to Checkout</a>
        </div>
    </div>
</div>

<!-- JS: Dynamic Cart Logic -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const cartBody = document.querySelector("tbody");

    function loadCart() {
        const saved = localStorage.getItem("cart");
        return saved ? JSON.parse(saved) : [];
    }

    function saveCart(cart) {
        localStorage.setItem("cart", JSON.stringify(cart));
    }

    function renderCart() {
        const cart = loadCart();
        cartBody.innerHTML = "";

        if (cart.length === 0) {
            cartBody.innerHTML = '<tr><td colspan="5" class="text-center">Your cart is empty.</td></tr>';
        } else {
            cart.forEach((item, index) => {
                const subtotal = (item.price * item.quantity).toFixed(2);
                cartBody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>$${item.price.toFixed(2)}</td>
                        <td><input type="number" value="${item.quantity}" class="form-control w-75 mx-auto" data-index="${index}"></td>
                        <td>$${subtotal}</td>
                        <td><button class="btn btn-sm btn-danger" data-index="${index}"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>
                `;
            });
        }

        calculateTotal();
        attachEvents();
    }

    function calculateTotal() {
        const cart = loadCart();
        let total = 0;
        cart.forEach(item => {
            total += item.price * item.quantity;
        });
        const totalPrice = document.querySelector("#total-price");
        if (totalPrice) {
            totalPrice.innerText = "$" + total.toFixed(2);
        }
    }

    function attachEvents() {
        const inputs = document.querySelectorAll("input[type='number']");
        const removeBtns = document.querySelectorAll("button.btn-danger");

        inputs.forEach(input => {
            input.addEventListener("change", function () {
                const cart = loadCart();
                const index = this.dataset.index;
                cart[index].quantity = parseInt(this.value) || 0;
                saveCart(cart);
                renderCart();
            });
        });

        removeBtns.forEach(btn => {
            btn.addEventListener("click", function () {
                const cart = loadCart();
                const index = this.dataset.index;
                cart.splice(index, 1);
                saveCart(cart);
                renderCart();
            });
        });
    }

    renderCart();
});
</script>

<!-- Required JS Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/main.js' %}"></script>
</body>
</html>
